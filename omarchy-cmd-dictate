#!/bin/bash

# Voice-to-text dictation for Hyprland — press once to record, again to transcribe + type.
# Uses whisper.cpp for offline speech recognition with automatic language detection.
#
# Usage: omarchy-cmd-dictate                  Toggle recording / transcribe
#        omarchy-cmd-dictate download-model [SIZE]  Download whisper model (tiny|base|small, default: base)

MODEL_DIR="${HOME}/.local/share/whisper/models"
RUNTIME_DIR="${XDG_RUNTIME_DIR:-/tmp}"
PIDFILE="${RUNTIME_DIR}/omarchy-cmd-dictate.pid"
AUDIOFILE="${RUNTIME_DIR}/omarchy-cmd-dictate.wav"
TEXTFILE="${RUNTIME_DIR}/omarchy-cmd-dictate.txt"

HF_BASE="https://huggingface.co/ggerganov/whisper.cpp/resolve/main"

download_model() {
  local size="${1:-base}"

  case "$size" in
    tiny)  local file="ggml-tiny.bin" ;;
    base)  local file="ggml-base.bin" ;;
    small) local file="ggml-small.bin" ;;
    *)
      echo "Supported sizes: tiny, base, small (default: base)"
      exit 1
      ;;
  esac

  mkdir -p "$MODEL_DIR"
  local dest="${MODEL_DIR}/${file}"

  if [[ -f "$dest" ]]; then
    echo "Model already exists: $dest"
    return 0
  fi

  echo "Downloading ${file}..."
  curl -L --progress-bar -o "$dest" "${HF_BASE}/${file}"
  echo "Saved to $dest"
}

find_model() {
  # Prefer base > small > tiny
  for size in base small tiny; do
    local path="${MODEL_DIR}/ggml-${size}.bin"
    [[ -f "$path" ]] && echo "$path" && return 0
  done
  return 1
}

stop_and_transcribe() {
  local pid
  pid=$(cat "$PIDFILE")
  kill "$pid" 2>/dev/null
  wait "$pid" 2>/dev/null
  rm -f "$PIDFILE"

  notify-send -t 2000 "Dictate" "Transcribing..."

  local model
  model=$(find_model)
  if [[ -z "$model" ]]; then
    notify-send -t 3000 "Dictate" "No model found — run: omarchy-cmd-dictate download-model"
    rm -f "$AUDIOFILE"
    return 1
  fi

  local text
  text=$(whisper-cli -m "$model" -l auto -nt -np -f "$AUDIOFILE" 2>/dev/null)
  rm -f "$AUDIOFILE"

  # Trim all leading/trailing whitespace including newlines
  text="${text#"${text%%[![:space:]]*}"}"
  text="${text%"${text##*[![:space:]]}"}"

  # Replace spoken punctuation with symbols (DE + EN)
  text=$(echo "$text" | sed -E \
    -e 's/ [Kk]omma/,/g' \
    -e 's/ [Pp]unkt([^a-zA-ZäöüÄÖÜ]|$)/.\1/g' \
    -e 's/ [Aa]usrufezeichen/!/g' \
    -e 's/ [Ff]ragezeichen/?/g' \
    -e 's/ [Dd]oppelpunkt/:/g' \
    -e 's/ [Ss]emikolon/;/g' \
    -e 's/ [Bb]indestrich/-/g' \
    -e 's/ [Gg]edankenstrich/ —/g' \
    -e 's/ [Aa]nführungszeichen auf/"/g' \
    -e 's/ [Aa]nführungszeichen zu/"/g' \
    -e 's/ [Kk]lammer auf/(/g' \
    -e 's/ [Kk]lammer zu/)/g' \
    -e 's/ [Nn]eue [Zz]eile/\n/g' \
    -e 's/ [Nn]euer [Aa]bsatz/\n\n/g' \
    -e 's/ [Cc]omma/,/g' \
    -e 's/ [Pp]eriod([^a-zA-Z]|$)/.\1/g' \
    -e 's/ [Ff]ull [Ss]top/./g' \
    -e 's/ [Ee]xclamation [Mm]ark/!/g' \
    -e 's/ [Qq]uestion [Mm]ark/?/g' \
    -e 's/ [Cc]olon/:/g' \
    -e 's/ [Ss]emicolon/;/g' \
    -e 's/ [Nn]ew [Ll]ine/\n/g' \
    -e 's/ [Nn]ew [Pp]aragraph/\n\n/g' \
  )

  if [[ -z "$text" ]]; then
    notify-send -t 2000 "Dictate" "No speech recognized"
    return 0
  fi

  echo -n "$text" | wl-copy
  echo -n "$text" > "$TEXTFILE"
  notify-send -t 3000 "Dictate" "Copied — press again to type:\n$(echo "$text" | head -c 200)"
}

paste_text() {
  rm -f "$TEXTFILE"
  wtype -M ctrl v -m ctrl
  notify-send -t 2000 "Dictate" "Pasted"
}

start_recording() {
  rm -f "$AUDIOFILE"
  pw-record --rate 16000 --channels 1 --format s16 "$AUDIOFILE" &
  echo $! > "$PIDFILE"
  disown
  notify-send -t 2000 "Dictate" "Recording..."
}

# --- Subcommands ---

if [[ "${1:-}" == "download-model" ]]; then
  download_model "${2:-base}"
  exit 0
fi

# --- Dependency check ---

if ! command -v whisper-cli &>/dev/null; then
  notify-send -t 3000 "Dictate" "whisper-cli is not installed (pacman: whisper.cpp)"
  exit 1
fi

if ! command -v wtype &>/dev/null; then
  notify-send -t 3000 "Dictate" "wtype is not installed"
  exit 1
fi

# --- Toggle (3 states: idle → recording → ready → idle) ---

if [[ -f "$PIDFILE" ]] && kill -0 "$(cat "$PIDFILE")" 2>/dev/null; then
  stop_and_transcribe
elif [[ -f "$TEXTFILE" ]]; then
  paste_text
else
  rm -f "$PIDFILE"
  start_recording
fi
